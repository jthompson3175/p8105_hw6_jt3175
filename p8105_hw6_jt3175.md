Homework 6
================
Julia Thompson
11/20/2019

## Problem 1

Load and clean the data for regression analysis (i.e. convert numeric to
factor where appropriate, check for missing data, etc.).

We load and clean the data for regression analysis, and find that there
are no missing values in any of the columns. We also recode and convert
*babysex*, *frace*, *malform*, and *mrace* to factor variables.

``` r
birthweight = read_csv("./data/birthweight.csv") 
```

    ## Parsed with column specification:
    ## cols(
    ##   .default = col_double()
    ## )

    ## See spec(...) for full column specifications.

``` r
# check for missing data

ismissing = map(.x = birthweight, ~ sum(is.na(.x))) %>%  # why do you need the ~ ?!?
  bind_cols()

# male = 1, female = 2
# 1 = White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other, 9 = Unknown
# 0 = absent, 1 = present
# 1 = White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other

# Recode variables to make sense

birthweight = birthweight %>% 
  mutate(
    babysex = recode(babysex, `1` = "male", `2` = "female"),
    frace = recode(frace, `1` = "white", `2` = "black", `3` = "asian", `4` = "puerto rican", `8` = "other", `9` = "unknown"),
    malform = recode(malform, `0` = "absent", `1` = "present"),
    mrace = recode(mrace,  `1` = "white", `2` = "black", `3` = "asian", `4` = "puerto rican", `8` = "other")
  )

# change the above recoded variables into factors with levels corresponding to the above order

birthweight = birthweight %>% 
  mutate(
    babysex = factor(babysex, levels = c("male", "female")),
    frace = factor(frace, levels = c("white", "black", "asian", "puerto rican", "other", "unknown")),
    malform = factor(malform, levels = c("absent", "present")),
    mrace = factor(mrace, levels = c("white", "black", "asian", "puerto rican", "other"))
  )
```

Propose a regression model for birthweight. This model may be based on a
hypothesized structure for the factors that underly birthweight, on a
data-driven model-building process, or a combination of the two.
Describe your modeling process and show a plot of model residuals
against fitted values – use add\_predictions and add\_residuals in
making this plot.

We used a hypothesized structure consulting literature for the factors
that underly birthweight to reduce our number of potential predictors.
We will continue with the following: gender (*babysex*), mother’s BMI
(*ppbmi*), mother’s height (*mheigth*), cigarettes smoked per day
(*smoken*), and mother’s age (*momage*). We chose a final model by
fitting an interaction term between mother’s age and number of
cigarettes smoked per day, as indicated by past research. Because the
interaction term is significant and there is evidence in the literature
of interaction between age and smoking, we will keep the interaction in
our final model. We then create a plot of residuals vs fitted values and
find that our points are centered around 0 with no clear patterns that
would be
problematic.

``` r
# interaction between smoking status and age - this interaction term is significant, so we will keep this as our final model

interaction_model = lm(bwt ~ babysex + ppbmi + mheight + momage*smoken, data = birthweight) 
summary(interaction_model)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex + ppbmi + mheight + momage * smoken, 
    ##     data = birthweight)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -2456.93  -268.89    23.88   312.92  1673.35 
    ## 
    ## Coefficients:
    ##               Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)     9.2435   193.5797   0.048  0.96192    
    ## babysexfemale -87.2849    14.9350  -5.844 5.46e-09 ***
    ## ppbmi          17.1699     2.3666   7.255 4.73e-13 ***
    ## mheight        38.3209     2.8463  13.464  < 2e-16 ***
    ## momage         18.2511     2.1579   8.458  < 2e-16 ***
    ## smoken         13.0265     5.0494   2.580  0.00992 ** 
    ## momage:smoken  -0.9308     0.2316  -4.018 5.97e-05 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 491.3 on 4335 degrees of freedom
    ## Multiple R-squared:  0.08112,    Adjusted R-squared:  0.07985 
    ## F-statistic: 63.78 on 6 and 4335 DF,  p-value: < 2.2e-16

``` r
# show a plot of residuals vs fitted

birthweight = 
  birthweight %>% 
  add_residuals(interaction_model) %>% 
  add_predictions(interaction_model)

# residuals are clustered, but there is no clear pattern... seems ok enough to proceed

ggplot(birthweight, aes(x = pred, y = resid))+
  geom_point()
```

<img src="p8105_hw6_jt3175_files/figure-gfm/unnamed-chunk-2-1.png" width="90%" />

Compare your model to two others:

One using length at birth and gestational age as predictors (main
effects only) One using head circumference, length, sex, and all
interactions (including the three-way interaction) between these

``` r
# This is just for me to think about it 

simple_model_given = lm(bwt ~ blength + gaweeks, data = birthweight)
summary(simple_model_given)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ blength + gaweeks, data = birthweight)
    ## 
    ## Residuals:
    ##     Min      1Q  Median      3Q     Max 
    ## -1709.6  -215.4   -11.4   208.2  4188.8 
    ## 
    ## Coefficients:
    ##              Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept) -4347.667     97.958  -44.38   <2e-16 ***
    ## blength       128.556      1.990   64.60   <2e-16 ***
    ## gaweeks        27.047      1.718   15.74   <2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 333.2 on 4339 degrees of freedom
    ## Multiple R-squared:  0.5769, Adjusted R-squared:  0.5767 
    ## F-statistic:  2958 on 2 and 4339 DF,  p-value: < 2.2e-16

``` r
complex_model_given = lm(bwt ~ babysex * bhead * blength, data = birthweight)
summary(complex_model_given)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex * bhead * blength, data = birthweight)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1132.99  -190.42   -10.33   178.63  2617.96 
    ## 
    ## Coefficients:
    ##                               Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)                 -7176.8170  1264.8397  -5.674 1.49e-08 ***
    ## babysexfemale                6374.8684  1677.7669   3.800 0.000147 ***
    ## bhead                         181.7956    38.0542   4.777 1.84e-06 ***
    ## blength                       102.1269    26.2118   3.896 9.92e-05 ***
    ## babysexfemale:bhead          -198.3932    51.0917  -3.883 0.000105 ***
    ## babysexfemale:blength        -123.7729    35.1185  -3.524 0.000429 ***
    ## bhead:blength                  -0.5536     0.7802  -0.710 0.478012    
    ## babysexfemale:bhead:blength     3.8781     1.0566   3.670 0.000245 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 287.7 on 4334 degrees of freedom
    ## Multiple R-squared:  0.6849, Adjusted R-squared:  0.6844 
    ## F-statistic:  1346 on 7 and 4334 DF,  p-value: < 2.2e-16

Make this comparison in terms of the cross-validated prediction error;
use crossv\_mc and functions in purrr as appropriate.

``` r
# need to create testing and training datasets to use on all 3 models.

# models to compare:
# interaction_model
# simple_model_given
# complex_model_given

cv_df = crossv_mc(birthweight, 10)

cv_df = cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
```

``` r
# Now fit the respective models to each

cv_df = 
  cv_df %>% 
  mutate(interaction_model = map(train, ~lm(bwt ~ babysex + ppbmi + mheight + momage * smoken, data = .x)),
         simple_model_given = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         complex_model_given = map(train, ~lm(bwt ~ babysex * bhead * blength, data = .x))) %>% 
  mutate(rmse_interaction = map2_dbl(interaction_model, test, ~rmse(model = .x, data = .y)),
         rmse_simple = map2_dbl(simple_model_given, test, ~rmse(model = .x, data = .y)),
         rmse_complex = map2_dbl(complex_model_given, test, ~rmse(model = .x, data = .y)))

cv_df %>% 
  select(starts_with("rmse")) %>% 
pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

<img src="p8105_hw6_jt3175_files/figure-gfm/unnamed-chunk-5-1.png" width="90%" />

<http://web.b.ebscohost.com/ehost/pdfviewer/pdfviewer?vid=1&sid=d6056f5b-5ea8-4211-8071-e675375944e1%40pdc-v-sessmgr04>

## Problem 2

``` r
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

    ## Registered S3 method overwritten by 'crul':
    ##   method                 from
    ##   as.character.form_file httr

    ## Registered S3 method overwritten by 'hoardr':
    ##   method           from
    ##   print.cache_info httr

    ## file path:          C:\Users\jbenn\AppData\Local\rnoaa\rnoaa\Cache/ghcnd/USW00094728.dly

    ## file last updated:  2019-09-26 10:36:48

    ## file min/max dates: 1869-01-01 / 2019-09-30

We’ll focus on a simple linear regression with tmax as the response and
tmin as the predictor.

Use 5000 bootstrap samples and, for each bootstrap sample, produce
estimates of these two quantities.

``` r
boot_straps = 
  weather_df %>% 
  modelr::bootstrap(n = 100)
```

``` r
bootstrap = 
  weather_df %>% 
  modelr::bootstrap(n = 100) %>% 
  mutate(
    models = map(strap, ~lm(tmax ~ tmin, data = .x))
  )

output = 
  bootstrap %>% 
  mutate(
    results_ln = map(models, broom::tidy),
    results_rsq = map(models, broom::glance)
    ) %>% 
  select(-strap, -models) %>% 
  unnest(results_ln, results_rsq) %>% 
  select(.id, term, estimate, adj.r.squared) %>% 
  pivot_wider(
    names_from = term, 
    values_from = estimate
  ) %>% 
  janitor::clean_names() %>% 
  mutate(
    ln_est = log(intercept * tmin)
  ) %>% 
  select(adj_r_squared, ln_est)
```

Plot the distribution of your estimates, and describe these in words.

Using the 5000 bootstrap estimates, identify the 2.5% and 97.5%
quantiles to provide a 95% confidence interval
